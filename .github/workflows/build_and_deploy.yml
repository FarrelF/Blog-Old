name: Build and Deploy
on: 
  push:
    branches:
      - master

jobs:
  build:
    name: Build
    runs-on: ubuntu-18.04
    env:
      TZ: Asia/Jakarta
      PYTHON_VERSION: 3.7
    steps:
    - name: Checkout the Code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Install and Set up Locales
      run: |
        sudo apt install locales locales-all
        sudo sed -i 's/id_ID\s.*$/id_ID id_ID.utf8/g' /usr/share/locale/locale.alias
        sudo sed -i 's/# id_ID\.UTF-8/id_ID\.UTF-8/' /etc/locale.gen
        sudo update-locale LANG=C.UTF-8 LC_MESSAGES=POSIX
        DEBIAN_FRONTEND=noninteractive sudo -E dpkg-reconfigure locales
        sudo ln -sf /usr/share/zoneinfo/Asia/Jakarta /etc/localtime

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v1
      with:
        python-version: "${{ env.PYTHON_VERSION }}"
    
    - name: Install and Set up Poetry
      run: |
        curl -sSL https://cdn.statically.io/gh/python-poetry/poetry/master/get-poetry.py | python
        source ${HOME}/.poetry/env
        poetry config virtualenvs.in-project true
        echo "::add-path::${HOME}/.poetry/bin"
    
    - name: Set up Python Modules Cache
      uses: actions/cache@v1
      with:
        path: .venv
        key: v1-python-${{ hashFiles('**/poetry.lock') }}-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: | 
          v1-python-${{ hashFiles('**/poetry.lock') }}-
    
    - name: Install Python Modules
      run: |
        poetry install --no-dev

    - name: Building the Blog HTML
      run: |
        poetry run make publish

    - name: Upload Outputs to Artifact
      uses: actions/upload-artifact@v1
      with:
        name: site-outputs
        path: ./output
  
  deploy:
    name: Deploy
    needs: build
    runs-on: ubuntu-18.04
    env:
      NODE_ENV: production
    steps:
    - name: Checkout the Code
      uses: actions/checkout@v2

    - name: Download Outputs from Artifact
      uses: actions/download-artifact@v1
      with:
        name: site-outputs
        path: ./output

    - name: Getting NodeJS and Yarn Version
      shell: bash -l -eo pipefail {0}
      run: |
        echo "::set-output name=NVMRC::$(cat .nvmrc)"
        echo "::set-output name=YVMRC::$(cat .yvmrc)"
      id: vm
    
    - name: Set up NodeJS
      uses: actions/setup-node@v1
      with:
        node-version: "${{ steps.vm.outputs.NVMRC }}"

    - name: Installing Yarn with YVM
      shell: bash -l -eo pipefail {0}
      run: | 
        curl -s https://raw.githubusercontent.com/tophat/yvm/master/scripts/install.js | node
        {
         echo 'YVM_DIR=${HOME}/.yvm && export YVM_DIR'
         echo '. "${YVM_DIR}"/yvm.sh'
        } >> ${HOME}/.bash_profile
        source ${HOME}/.bash_profile
        yvm install "${{ steps.vm.outputs.YVMRC }}" && yvm set-default "${{ steps.vm.outputs.YVMRC }}"
      
    - name: Installing Netlify CLI with Yarn
      shell: bash -l -eo pipefail {0}
      run: |
        yarn global add netlify-cli
        echo "::set-env name=GIT_COMMIT_HASH::$(git log --format="%h" -n 1 ${GITHUB_SHA})"
        echo "::set-env name=GIT_COMMIT_MESSAGE::$(git log --format="%s" -n 1 ${GITHUB_SHA})"
        echo "::set-env name=BRANCH_NAME::$(echo ${GITHUB_REF#refs/heads/} | sed 's/\//_/g')"
        echo "::add-path::$(yarn global bin)"
      
    - name: Deploying with Netlify
      shell: bash -l -eo pipefail {0}
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      run: |
        netlify deploy --dir=./output -p -m "GitHub Actions (${GIT_COMMIT_HASH})":" ${BRANCH_NAME} - ${GIT_COMMIT_MESSAGE}"

    - name: "Deleting Artifacts"
      shell: bash -l -eo pipefail {0}
      run: |
        curl -H "Authorization: Bearer ${{secrets.GITHUB.TOKEN}}" "https://api.github.com/repos/${{github.repository}}/actions/runs/${{github.run_id}}/artifacts" | jq ".artifacts | .[] | .id" | tee artifacts
        cat artifacts | xargs -n1 -i curl -H "Authorization: Bearer ${{secrets.GITHUB_TOKEN}}" -X DELETE "https://api.github.com/repos/${{github.repository}}/actions/artifacts/{}"
